---
title: 12장 - 채팅 시스템 설계
date: 2023-11-16
tags: ["가상 면접 사례로 배우는 대규모 시스템 설계 기초 스터디"]
description: 12장 - 채팅 시스템 설계 정리본
---

## 목표

채팅 앱을 만들어보자!

## 1단계 문제 이해 및 설계 범위 확정

채팅 앱이라고 했을 때 사람들이 떠올리는 것은 제각각이다.  
일대일 채팅, 그룹 채팅, 응답지연이 낮아야하는 음성 채팅등 여려 경우가 있다.  
질문을 통해 원하는 앱이 무엇인지 정확히 알아내야한다.

지원자 질문

- 1:1 채팅 앱인지 그룹 채팅 앱인지
- 모바일 앱인지 웹 앱인지
- 처리해야하는 트래픽 규모는?
- 그룹 채팅의 경우에 인원 제한이 있는지?
- 중요기능으로 어떤 것이 있는지?
- 메시지 길이에 제한이 있는지?
- 종단간 암호화를 지원해야 하는지?
- 채팅 이력은 얼마나 오래 보관해야 하는지?

도출 된 정보

- 응답지연이 낮은 일대일 채팅 기능
- 최대 100명까지 참여할 수 있는 그룹 채팅 기능
- 사용자의 접속상태 표시 기능
- 다양한 단말 지원. 하나의 계정으로 여러 단말에 동시 접속 지원
- 푸시 알림
- 5천만 DAU를 처리할 수 있도록 할 것

## 2단계 개략적 설게안 제시 및 동의 구하기

클라이언트는 서로 직접 통신하지 않기 때문에 채팅 서비스와 통신을 해야한다.  
채팅 서비스는 다음 기능을 제공해야 한다.

- 클라이언트들로부터 메시지 수신
- 메시지 수신자(recipeint) 결정 및 전달
- 수신자가 접속 상태가 아닌 경우 접속할 때 가지 메시지 보관

채팅 서비스의 경우 어떤 통신 프로토콜을 사용할 것인가도 중요한 문제이다.

HTTP의 경우에는 메시지 전송 요도로 괜찮은 선택이다.  
(keep-alive헤더를 통해 끊지않고 계속 유지할 수 도 있음)

하지만 메시지 수신 시나리오는 복잡하다.  
HTTP는 클라이언트가 연결을 만드는 프로토콜이므로, 서버에서 클라이언트로 임의 시점에 메시지를 보내는 데는 쉽게 쓰일 수 없다.

서버가 연결을 만드는 것처럼 동작할 수 있도록 많은 기법들이 존재하는데 이에 대해 알아보자.

### 폴링

클라이언트가 주기적으로 서버에게 새 메시지가 있느냐고 물어보븝 방법.  
폴링을 자주하면 폴링비용이 올라감 + 메시지가 없는 경우 서버 자원 낭비

### 롱 폴링

클라이언트는 새 메시지가 반환되거나 타임아웃 될 때까지 연결을 유지한다.
클라이언트는 새 메시지를 받으면 기존 연결을 종료하고 서버에 새로운 요청을 보내어 모든 절차를 다시 시작한다.

<img src="/images/LSS/longPolling.jpg" width="80%" height="100%" />

단점

- 메시지를 보내는 클라이언트와 수신하는 클라이언트가 같은 채팅 서버에 접속하게 되지 않을 수 있음
- 서버 입장에서는 클라이언트가 연결을 해제했는지 아닌지 알 좋은 방법이 없다
- 메시지를 많이 받지 않은 클라이언트도 주기적으로 서버에 다시 접속해야함

### 웹 소켓

서버가 클라이언트에게 비동기메시지를 보낼때 가장 널리 사용하는 기술

웹소켓 연결은 클라이언트가 시작하여, 한번 맺어진 연결은 항구적이며 양방향이다.
한번 만들어지면 클라이언트에게 비동기적으로 메시지를 전송할 수 있다.

웹소켓을 이용하면 메시지를 보낼 때나 받을 때 동일한 프로토콜을 사용할 수 있음
구현도 단순하고 직관적이다.

웹 소켓 연결은 항구적으로 유지되어야하기 때문에 연결관리를 효율적으로 해야한다.

### 개략적인 설계안

클라이언트와 주 서버 통신 프로토콜 : 웹 소켓
이외 대부분의 기능(회원가입, 로그인, 사용자 프로파일 등) : HTTP

#### 무상태 서비스

전통적인 요청/응답 서비스로 로그인, 회원가입, 사용자 프로파일 표시 등

<img src="/images/LSS/nonstateful.jpg" width="80%" height="100%" />

로드밸런서를 사용하며 모놀리틱, 마이크로서비스 등으로 구현한다.

#### 상태 유지 서비스

각 클라이언트가 채팅 서버와 독립적인 네트워크 연결을 유지해야 한다.  
클라이언트는 서버가 살아 있는 한 다른 서버로 연결을 변경하지 않는다.

서비스 탐색 서비스, 채팅 서비스와 협력하여 특정 서버에 부하가 몰리지 않도록 하여야 한다.

#### 제3자 서비스 연동

제 3자 서비스 : 푸시 알림  
새 메시지를 받았다면 설사 앱이 실행 중이지 않더라도 알림을 받아야 해서이다.

#### 규모 확장성

<img src="/images/LSS/chatfullserver.jpg" width="80%" height="100%" />

이론적으로는 모든 사용자 연결을 최신 클라우드 서버 한대로 처리할 수 있기는 여러이유(SPOF등)으로 분할하나 한대를 갖는 설계안으로 출발하여 다듬어 나가는 것도 괜찮다. 다음은 서버를 한 대만 갖는 설계안이다.  
키-값 저장소에는 채팅 이력을 보관한다.

#### 저장소

어떤 데이터 베이스를 쓸 것 인가? 데이터의 유형과 읽기/쓰기 연산의 패턴을 중요하게 봐야한다.

채팅 시스템이 다루는 데이터

- 사용자 프로파일, 설정, 친구목록  
   안전성을 보장하는 관계형 데이터 베이스에 보관
- 채팅 이력
  채팅 데이터는 패턴을 알아보자

채팅 데이터의 패턴

- 양이 엄청나다.
- 빈번하게 사용되는 것은 주로 최근에 주고받는 메시지다.
- 대체로 최근에 주고받은 메시지 데이터를 참고하나 특정 메시지로 점프하여 무작위적인 데이터 접근을 하게되는 일도 있다.
- 1:1 채팅 앱의 경우 읽기:쓰기 비율은 대략 1:1정도다.
