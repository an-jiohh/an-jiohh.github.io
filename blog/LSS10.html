<!DOCTYPE html><html lang="kr"><head><meta charSet="utf-8"/><link rel="preload" as="font" href="/_next/static/media/e4af272ccee01ff0-s.p.woff2" crossorigin="" type="font/woff2"/><link rel="stylesheet" href="/_next/static/css/b3171e58fb80086c.css" data-precedence="next"/><link rel="preload" href="/_next/static/chunks/webpack-479ea16dcba490db.js" as="script"/><link rel="preload" href="/_next/static/chunks/fd9d1056-5fc0659828b82348.js" as="script"/><link rel="preload" href="/_next/static/chunks/596-5f69a5936ae99734.js" as="script"/><link rel="preload" href="/_next/static/chunks/main-app-cdff0bafbbbf8fd3.js" as="script"/><title>지호의 블로그</title><meta name="description" content="Generated by create next app"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="icon" href="/favicon.ico" type="image/x-icon" sizes="16x16"/><meta name="next-size-adjust"/><script src="/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js" noModule=""></script></head><body class="__className_e8ce0c"><div class="w-full flex flex-col items-center p-3"><header class="w-full max-w-3xl flex flex-row justify-between items-center my-1"><a class="flex flex-row items-center" href="/"><img alt="로고" loading="lazy" width="30" height="30" decoding="async" data-nimg="1" class="rounded-full" style="color:transparent" src="/logo.png"/><span class="mx-2 font-semibold text-lg">jiohh blog</span></a><nav><a class="mr-5 " href="/">Home</a><a class="mr-5 " href="/blog">Blog</a><a class="mr-5 " href="/category">Category</a></nav></header><main class="w-full max-w-3xl"><div class="mt-10 prose"><h1 class="">10장 - 알림 시스템 설계</h1><h2>목표</h2>
<p>알림 시스템은 여러 정보들을 고객들에게 비동기적으로 제공한다.<br/>
<!-- -->모바일 푸시알림에 한정되지 않고 sms메시지, 이메일의 세 가지로 분류할 수 있다.<br/>
<!-- -->이러한 알림 시스템을 설계해보자.</p>
<h2>1단계 문제 이해 및 설계 범위 확정</h2>
<p>지원자 질문</p>
<ul>
<li>어떤 종류의 알림을 지원?</li>
<li>실시간 시스템이여야 하는지?</li>
<li>어떤 종류의 단말을 지원?</li>
<li>사용자에게 보낼 알림은 누가 만들 수 있는지?</li>
<li>사용자가 알림을 받지 않도록 설정할 수 있는지?</li>
<li>하루에 몇 건의 알림을 보낼 수 있어야 하는지?</li>
</ul>
<p>면접관 대답</p>
<ul>
<li>푸시알림, sms 메시지, 이메일</li>
<li>soft real-time(연성 실시간) 시스템으로 가정, 알림은 가능한 빨리 전달되어야 하지만 시스템에 높은 부하가 걸렸을 때 약간의 지연은 무방</li>
<li>ios, 안드로이드, 데스크톱 지원</li>
<li>클라이언트 애플리케이션 또는 서버측 스케줄링</li>
<li>설정을 하면 알림을 받지 않게 설계</li>
<li>천만 건의 모바일, 백 만건의 sms, 5백만 건의 이메일을 보낼 수 있어야함</li>
</ul>
<h2>2단계 개략적 설계안 제시 및 동의 구하기</h2>
<p>다음과 같은 개략적 설계안을 살펴 볼 것이다.</p>
<h3>알림 유형별 지원 방안</h3>
<h4>ios 푸시 알림</h4>
<p>ios에서 푸시 알림을 보내기 위해서는 세가지 컴포넌트가 필요하다</p>
<p>알림 제공자 ➡️ APNS ➡️ ios 단말</p>
<ul>
<li>알림 제공자(provider): 알림 요청을 만들어 APNS로 보내는 주체<!-- -->
<ul>
<li>단말 토큰 : 알림 요청을 보내는데 필요한 고유 식별자</li>
<li>페이로드 : 알림 내용을 담은 JSON</li>
</ul>
</li>
<li>APNS(Apple Push Notification Service) : 애플이 제공하는 원격서비스<br/>
<!-- -->푸시 알림을 ios장치로 보내는 역할</li>
<li>ios 단말 : 알림 수신</li>
</ul>
<h4>안드로이드 푸시 알림</h4>
<p>ios와 동일하게 동작하나 APNS 대신 FCM(firebase Cloud Messaging)을 사용한다</p>
<h4>sms메시지</h4>
<p>제 3 사업자(Twilio, Nexmo)의 서비스를 이용하여 제공</p>
<h4>이메일</h4>
<p>고유 이메일 서버를 구축할 역량이 있으나, 상용 이메일 서비스(Sendgrid, Mailchimp)등을 사용한다.<br/>
<!-- -->➡️ 전송 성공률도 높고, 데이터 분석 서비스도 제공하기 때문</p>
<img src="/images/LSS/alarmService.jpg" width="50%" height="100%"/>
<p>알림 유형 전부를 묶으면 다음과 같다.</p>
<h3>연락처 정보 수집 절차</h3>
<p>알림을 보내려면 모바일 단말 토큰, 전화번호, 이메일 주소 등의 정보가 필요하다.</p>
<img src="/images/LSS/alarmUserInfo.jpg" width="100%" height="100%"/>
<p>앱을 처음으로 등록하면 API 서버는 해당 사용자의 정보를 수집하여 데이터베이스에 저장한다.</p>
<ul>
<li>
<p>user 테이블</p>
<ul>
<li>user_id</li>
<li>email</li>
<li>etc...</li>
</ul>
</li>
<li>
<p>device 테이블</p>
<ul>
<li>id</li>
<li>user_id</li>
<li>device_token</li>
</ul>
</li>
</ul>
<p>user, device테이블을 1대다 형태로 사용하는데 한 사용자가 여러 단말을 가질 수 있고, 알림은 모든 단말에 전송되어야 한다는 점을 고려한 설계이다.</p>
<h3>알림 전송 및 수신 절차</h3>
<p>개략적인 설계안을 살펴보고, 점차 최적화해 나가보자</p>
<h4>개략적 설계안</h4>
<img src="/images/LSS/alarmprocess1.jpg" width="100%" height="100%"/>
<ul>
<li>1부터 N까지의 서비스 : 각각 마이크로 서비스 또는 크론잡(시간 기반 잡)일 수도 있고, 분산스템 컴포넌트일 수도 있다.</li>
<li>알림 시스템 : 알림 전송/수신 처리의 핵심으로
1~N까지의 서비스에 알림 전송을 위한 API 제공
제 3자 서비스에 전달할 알림 페이로드를 만들어 내야함</li>
<li>제 3자 서비스 : 알림을 실제로 전달하는 역할<!-- -->
<ol>
<li>통합을 진행할때 확장성, 새로운 서비스와 통합,제거가 용이하는지 고려</li>
<li>다른 시장(중국 시장 등) 사용할 수 있는 서비스인지 확인해야함</li>
</ol>
</li>
</ul>
<p>이 설계에는 다음과 같은 문제가 있다.</p>
<ul>
<li>SPOF : 알림서비스에 서버가 하나로 서비스 장애 쉬움</li>
<li>규모 확장성 : 한 대 서비스로 푸시 알림에 관계된 모든 것을 처리하므로, 규모를 늘릴 방법이 없음</li>
<li>성능 병목 : 알림을 처리하고 보내는 것은 많은 작업을 필요로 할 수 있다.(HTML을 만들고 제3자의 응답을 기다려야하는 경우)
➡️ 병목시 모든 알림이 처리되지 않는 과부하 상태에 빠질 수 있음</li>
</ul>
<h4>개략적 설계안(개선된 버전)</h4>
<img src="/images/LSS/alarmprocess2.jpg" width="100%" height="100%"/>
<ul>
<li>데이터베이스와 캐시를 알림 시스템의 주 서버에서 분리</li>
<li>알림 서버를 증설하고 수평적 규모 확장가능하도록</li>
<li>메시지 큐를 사용 ➡️ 시스템 컴포넌트의 강한 결합 제거</li>
</ul>
<p>시스템 컴포넌트 설명</p>
<ul>
<li>
<p>알림 서버 : 다음 기능을 제공한다</p>
<ul>
<li>알림 전송 API : 스팸 방지를 위해 보통 사내 서비스 또는 인증된 클라이언트만 이용가능하다</li>
<li>알림 검증 : 이메일 주소, 전화번호 등에 대한 기본적인 검증 수행</li>
<li>데이터베이스 또는 캐시 질의 : 알림에 포함시킬 데이터를 가져옴</li>
<li>알림 전송 : 알림 데이터를 메시지 큐에 넣는다.<br/>
<!-- -->➡️ 하나 이상의 메시지 큐를 사용으로 병렬적으로 처리</li>
</ul>
</li>
<li>
<p>캐시 : 사용자 정보, 단말 정보, 알림 템플릿 등을 캐시한다.</p>
</li>
<li>
<p>데이터베이스 : 사용자, 알림, 설정 등 다양한 정보를 저장</p>
</li>
<li>
<p>메시지 큐 : 시스템 컴포넌트 간 의존성을 제거, 다량의 알림 전송일때 버퍼 역할</p>
</li>
<li>
<p>작업 서버 : 메시지 큐에서 전송할 알림을 꺼내서 제 3자 서비스로 전달</p>
</li>
</ul>
<p>다음과 같은 과정을 거친다.</p>
<ol>
<li>API 호출하여 알림 서버로 알림 보냄</li>
<li>알림 서버는 메타데이터(사용자 정보, 단말 토큰, 알림 설정)를 캐시나 데이터베이스에서 가져옴</li>
<li>알림 서버는 전송할 알림에 맞는 이벤트를 만들어 한 큐에 넣는다.</li>
<li>작업 서버는 메시지 큐에서 알림 이벤트를 꺼낸다.</li>
<li>작업 서버는 알림을 제3자 서비스로 보낸다.</li>
</ol>
<h2>3단계 상세 설계</h2>
<ul>
<li>안정성</li>
<li>추가로 필요한 컴포넌트 및 고려 사항</li>
<li>개선된 설계안</li>
</ul>
<p>세가지 내용을 좀더 자세히 알아보자</p>
<h3>안정성</h3>
<h4>데이터 손실 방지</h4>
<p>알림 전송 시스템의 가장 중요한 요구사항 중 하나는 어떤 상황에서도 알림이 소실되면 안된다는 것이다.(지연, 순서바뀜은 가능하지만 사라지면 안됨)
이 요구사항을 만족하려면 알림 데이터를 데이터베이스에 보관하고 재시도 메커니즘을 구현해야 한다.</p>
<img src="/images/LSS/dataforget.jpg" width="80%" height="100%"/>
<p>다음과 같이 알림 로그 데이터베이스를 유지하는 것이 한 가지 방법이다.</p>
<h4>알림 중복 전송 방지</h4>
<p>같은 알림이 여러번 반복되는 것을 완전히 막는 것은 가능하지 않다. 분산 시스템으로 가끔은 중복 전송되기도 한다.<br/>
<!-- -->그 빈도를 줄이려면</p>
<ol>
<li>중복을 탐지하는 메커니즘 도입</li>
<li>오류를 신중하게 처리해야함<!-- -->
<ul>
<li>보내야할 알림이 도착, 이벤트ID를 검사하여 이전에 보낸 이벤트인지 확인</li>
</ul>
</li>
</ol>
<h3>추가로 필요한 컴포넌트 및 고려사항</h3>
<h4>알림 템플릿</h4>
<p>대형 알림 시스템은 많은 알림을 처리한다. 대부분이 형식이 비슷하다.<br/>
<!-- -->이러한 유사성을 고려하여 모든 부분을 처음부터 다시 만들 필요가 없도록(템플릿)한다.<br/>
<!-- -->오류 가능성이나 알림 작성에 드는 시간도 줄일 수 있다.</p>
<h4>알림 설정</h4>
<p>여러 서비스는 사용자가 알림 설정을 조정할 수 있도록 하고있다.<br/>
<!-- -->이러한 정보는 알림 설정 테이블에 보관되며, 특정 종류의 알림을 보내기 전에 데이터베이스를 확인한 후 보낸다.</p>
<h4>전송률 제한</h4>
<p>사용자에가 받을 수 있는 알림의 빈도를 제한하여 너무 많은 알림을 보내지 않도록한다.</p>
<h4>재시도 방법</h4>
<p>제3자 서비스가 알림 전송에 실패하면 해당알림을 재시도 전용 큐에 넣는다.<br/>
<!-- -->문제가 계속 발생시 개발자에게 통지한다.</p>
<h4>푸시 알림과 보안</h4>
<p>모바일 푸시 알림의 경우 appKey와 appSecret을 사용하여 보안을 유지한다.<br/>
<!-- -->따라서 인증된 혹은 승인된 클라이언트만 알림을 보낼 수 있다.</p>
<h4>큐 모니터링</h4>
<p>큐에 쌓인 알림의 개수가 모니터링할때 중요한 메트릭(주요사항)이다.
이 수가 너무크면 이벤트를 빠르게 처리하고 있지 못하고있다는 뜻이다.</p>
<h4>이벤트 추적</h4>
<img src="/images/LSS/eventAnalytics.jpg" width="70%" height="100%"/>
<p>여러 이벤트 들은 사용자를 이해하는데 중요하다.<br/>
<!-- -->데이터 분석 서비스를 통해 추적하게될 알림 시스템 이벤트의 사례이다.</p>
<h3>수정된 설계안</h3>
<img src="/images/LSS/alarmSystem.jpg" width="100%" height="100%"/>
<ul>
<li>알림 서버에 인증과 전송률 제한 기능이 추가</li>
<li>전송 실패 대응을 위한 재시도 기능 추가</li>
<li>전송 템플릿을 사용</li>
<li>모니터링과 추적 시스템 추가</li>
</ul>
<h2>4단계 마무리</h2>
<ul>
<li>안정성 : 실패율을 낮추기 위한 재시도 매커니즘 도입</li>
<li>보안 : appKey, appSecret를 이용한 알림을 보안</li>
<li>이벤트 추적 및 모니터링</li>
<li>사용자 설정 : 사용자가 알림 수신 설정</li>
<li>전송률 제한 : 사용자에게 알림을 보내는 빈도를 제한</li>
</ul>
<p>다음과 같은 컴포넌트 구현 방버과 최적화 기법에 대해 알아보았다.</p></div></main><footer class="w-full max-w-3xl items-center "><div class="h-28"></div> </footer></div><script src="/_next/static/chunks/webpack-479ea16dcba490db.js" async=""></script><script src="/_next/static/chunks/fd9d1056-5fc0659828b82348.js" async=""></script><script src="/_next/static/chunks/596-5f69a5936ae99734.js" async=""></script><script src="/_next/static/chunks/main-app-cdff0bafbbbf8fd3.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:HL[\"/_next/static/media/e4af272ccee01ff0-s.p.woff2\",{\"as\":\"font\",\"type\":\"font/woff2\"}]\n2:HL[\"/_next/static/css/b3171e58fb80086c.css\",{\"as\":\"style\"}]\n0:\"$L3\"\n"])</script><script>self.__next_f.push([1,"4:I{\"id\":7948,\"chunks\":[\"272:static/chunks/webpack-479ea16dcba490db.js\",\"971:static/chunks/fd9d1056-5fc0659828b82348.js\",\"596:static/chunks/596-5f69a5936ae99734.js\"],\"name\":\"default\",\"async\":false}\n6:I{\"id\":6628,\"chunks\":[\"272:static/chunks/webpack-479ea16dcba490db.js\",\"971:static/chunks/fd9d1056-5fc0659828b82348.js\",\"596:static/chunks/596-5f69a5936ae99734.js\"],\"name\":\"\",\"async\":false}\n7:I{\"id\":6685,\"chunks\":[\"685:static/chunks/685-1c7543f9470b706b.js\",\"222:static/chunks/222-846c3dee61afe17f.js\",\"404:static"])</script><script>self.__next_f.push([1,"/chunks/app/blog/page-4c4ed4280d9bd9ea.js\"],\"name\":\"\",\"async\":false}\n8:I{\"id\":3222,\"chunks\":[\"685:static/chunks/685-1c7543f9470b706b.js\",\"222:static/chunks/222-846c3dee61afe17f.js\",\"404:static/chunks/app/blog/page-4c4ed4280d9bd9ea.js\"],\"name\":\"Image\",\"async\":false}\n9:I{\"id\":7767,\"chunks\":[\"272:static/chunks/webpack-479ea16dcba490db.js\",\"971:static/chunks/fd9d1056-5fc0659828b82348.js\",\"596:static/chunks/596-5f69a5936ae99734.js\"],\"name\":\"default\",\"async\":false}\na:I{\"id\":7920,\"chunks\":[\"272:static/chunks/webpa"])</script><script>self.__next_f.push([1,"ck-479ea16dcba490db.js\",\"971:static/chunks/fd9d1056-5fc0659828b82348.js\",\"596:static/chunks/596-5f69a5936ae99734.js\"],\"name\":\"default\",\"async\":false}\n"])</script><script>self.__next_f.push([1,"3:[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/b3171e58fb80086c.css\",\"precedence\":\"next\"}]],[\"$\",\"$L4\",null,{\"buildId\":\"uXzr8GmWlpcjsubup2flq\",\"assetPrefix\":\"\",\"initialCanonicalUrl\":\"/blog/LSS10\",\"initialTree\":[\"\",{\"children\":[\"blog\",{\"children\":[[\"slug\",\"LSS10\",\"d\"],{\"children\":[\"__PAGE__?{\\\"slug\\\":\\\"LSS10\\\"}\",{}]}]}]},\"$undefined\",\"$undefined\",true],\"initialHead\":\"$L5\",\"globalErrorComponent\":\"$6\",\"children\":[null,[\"$\",\"html\",null,{\"lang\":\"kr\",\"children\":[\"$\",\"body\",null,{\"className\":\"__className_e8ce0c\",\"children\":[\"$\",\"div\",null,{\"className\":\"w-full flex flex-col items-center p-3\",\"children\":[null,[\"$\",\"header\",null,{\"className\":\"w-full max-w-3xl flex flex-row justify-between items-center my-1\",\"children\":[[\"$\",\"$L7\",null,{\"href\":\"/\",\"className\":\"flex flex-row items-center\",\"children\":[[\"$\",\"$L8\",null,{\"src\":\"/logo.png\",\"alt\":\"로고\",\"width\":30,\"height\":30,\"objectFit\":\"cover\",\"className\":\"rounded-full\"}],[\"$\",\"span\",null,{\"className\":\"mx-2 font-semibold text-lg\",\"children\":\"jiohh blog\"}]]}],[\"$\",\"nav\",null,{\"children\":[[\"$\",\"$L7\",\"Home\",{\"href\":\"/\",\"className\":\"mr-5 \",\"children\":\"Home\"}],[\"$\",\"$L7\",\"Blog\",{\"href\":\"/blog\",\"className\":\"mr-5 \",\"children\":\"Blog\"}],[\"$\",\"$L7\",\"Category\",{\"href\":\"/category\",\"className\":\"mr-5 \",\"children\":\"Category\"}]]}]]}],[\"$\",\"main\",null,{\"className\":\"w-full max-w-3xl\",\"children\":[\"$\",\"$L9\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$La\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":\"404\"}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],\"notFoundStyles\":\"$undefined\",\"childProp\":{\"current\":[\"$\",\"$L9\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$La\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"childProp\":{\"current\":[\"$\",\"$L9\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\",[\"slug\",\"LSS10\",\"d\"],\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$La\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"childProp\":{\"current\":[\"$Lb\",[\"$\",\"div\",null,{\"className\":\"mt-10 prose\",\"children\":[[\"$\",\"h1\",null,{\"className\":\"\",\"children\":\"10장 - 알림 시스템 설계\"}],[[\"$\",\"h2\",null,{\"children\":\"목표\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"알림 시스템은 여러 정보들을 고객들에게 비동기적으로 제공한다.\",[\"$\",\"br\",null,{}],\"\\n\",\"모바일 푸시알림에 한정되지 않고 sms메시지, 이메일의 세 가지로 분류할 수 있다.\",[\"$\",\"br\",null,{}],\"\\n\",\"이러한 알림 시스템을 설계해보자.\"]}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"1단계 문제 이해 및 설계 범위 확정\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"지원자 질문\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"어떤 종류의 알림을 지원?\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"실시간 시스템이여야 하는지?\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"어떤 종류의 단말을 지원?\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"사용자에게 보낼 알림은 누가 만들 수 있는지?\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"사용자가 알림을 받지 않도록 설정할 수 있는지?\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"하루에 몇 건의 알림을 보낼 수 있어야 하는지?\"}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"면접관 대답\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"푸시알림, sms 메시지, 이메일\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"soft real-time(연성 실시간) 시스템으로 가정, 알림은 가능한 빨리 전달되어야 하지만 시스템에 높은 부하가 걸렸을 때 약간의 지연은 무방\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"ios, 안드로이드, 데스크톱 지원\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"클라이언트 애플리케이션 또는 서버측 스케줄링\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"설정을 하면 알림을 받지 않게 설계\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"천만 건의 모바일, 백 만건의 sms, 5백만 건의 이메일을 보낼 수 있어야함\"}],\"\\n\"]}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"2단계 개략적 설계안 제시 및 동의 구하기\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"다음과 같은 개략적 설계안을 살펴 볼 것이다.\"}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"알림 유형별 지원 방안\"}],\"\\n\",[\"$\",\"h4\",null,{\"children\":\"ios 푸시 알림\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"ios에서 푸시 알림을 보내기 위해서는 세가지 컴포넌트가 필요하다\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"알림 제공자 ➡️ APNS ➡️ ios 단말\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"알림 제공자(provider): 알림 요청을 만들어 APNS로 보내는 주체\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"단말 토큰 : 알림 요청을 보내는데 필요한 고유 식별자\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"페이로드 : 알림 내용을 담은 JSON\"}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"APNS(Apple Push Notification Service) : 애플이 제공하는 원격서비스\",[\"$\",\"br\",null,{}],\"\\n\",\"푸시 알림을 ios장치로 보내는 역할\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"ios 단말 : 알림 수신\"}],\"\\n\"]}],\"\\n\",[\"$\",\"h4\",null,{\"children\":\"안드로이드 푸시 알림\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"ios와 동일하게 동작하나 APNS 대신 FCM(firebase Cloud Messaging)을 사용한다\"}],\"\\n\",[\"$\",\"h4\",null,{\"children\":\"sms메시지\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"제 3 사업자(Twilio, Nexmo)의 서비스를 이용하여 제공\"}],\"\\n\",[\"$\",\"h4\",null,{\"children\":\"이메일\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"고유 이메일 서버를 구축할 역량이 있으나, 상용 이메일 서비스(Sendgrid, Mailchimp)등을 사용한다.\",[\"$\",\"br\",null,{}],\"\\n\",\"➡️ 전송 성공률도 높고, 데이터 분석 서비스도 제공하기 때문\"]}],\"\\n\",[\"$\",\"img\",null,{\"src\":\"/images/LSS/alarmService.jpg\",\"width\":\"50%\",\"height\":\"100%\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"알림 유형 전부를 묶으면 다음과 같다.\"}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"연락처 정보 수집 절차\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"알림을 보내려면 모바일 단말 토큰, 전화번호, 이메일 주소 등의 정보가 필요하다.\"}],\"\\n\",[\"$\",\"img\",null,{\"src\":\"/images/LSS/alarmUserInfo.jpg\",\"width\":\"100%\",\"height\":\"100%\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"앱을 처음으로 등록하면 API 서버는 해당 사용자의 정보를 수집하여 데이터베이스에 저장한다.\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"\\n\",[\"$\",\"p\",null,{\"children\":\"user 테이블\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"user_id\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"email\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"etc...\"}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"\\n\",[\"$\",\"p\",null,{\"children\":\"device 테이블\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"id\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"user_id\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"device_token\"}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"user, device테이블을 1대다 형태로 사용하는데 한 사용자가 여러 단말을 가질 수 있고, 알림은 모든 단말에 전송되어야 한다는 점을 고려한 설계이다.\"}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"알림 전송 및 수신 절차\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"개략적인 설계안을 살펴보고, 점차 최적화해 나가보자\"}],\"\\n\",[\"$\",\"h4\",null,{\"children\":\"개략적 설계안\"}],\"\\n\",[\"$\",\"img\",null,{\"src\":\"/images/LSS/alarmprocess1.jpg\",\"width\":\"100%\",\"height\":\"100%\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"1부터 N까지의 서비스 : 각각 마이크로 서비스 또는 크론잡(시간 기반 잡)일 수도 있고, 분산스템 컴포넌트일 수도 있다.\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"알림 시스템 : 알림 전송/수신 처리의 핵심으로\\n1~N까지의 서비스에 알림 전송을 위한 API 제공\\n제 3자 서비스에 전달할 알림 페이로드를 만들어 내야함\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"제 3자 서비스 : 알림을 실제로 전달하는 역할\",\"\\n\",[\"$\",\"ol\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"통합을 진행할때 확장성, 새로운 서비스와 통합,제거가 용이하는지 고려\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"다른 시장(중국 시장 등) 사용할 수 있는 서비스인지 확인해야함\"}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"이 설계에는 다음과 같은 문제가 있다.\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"SPOF : 알림서비스에 서버가 하나로 서비스 장애 쉬움\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"규모 확장성 : 한 대 서비스로 푸시 알림에 관계된 모든 것을 처리하므로, 규모를 늘릴 방법이 없음\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"성능 병목 : 알림을 처리하고 보내는 것은 많은 작업을 필요로 할 수 있다.(HTML을 만들고 제3자의 응답을 기다려야하는 경우)\\n➡️ 병목시 모든 알림이 처리되지 않는 과부하 상태에 빠질 수 있음\"}],\"\\n\"]}],\"\\n\",[\"$\",\"h4\",null,{\"children\":\"개략적 설계안(개선된 버전)\"}],\"\\n\",[\"$\",\"img\",null,{\"src\":\"/images/LSS/alarmprocess2.jpg\",\"width\":\"100%\",\"height\":\"100%\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"데이터베이스와 캐시를 알림 시스템의 주 서버에서 분리\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"알림 서버를 증설하고 수평적 규모 확장가능하도록\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"메시지 큐를 사용 ➡️ 시스템 컴포넌트의 강한 결합 제거\"}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"시스템 컴포넌트 설명\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"\\n\",[\"$\",\"p\",null,{\"children\":\"알림 서버 : 다음 기능을 제공한다\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"알림 전송 API : 스팸 방지를 위해 보통 사내 서비스 또는 인증된 클라이언트만 이용가능하다\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"알림 검증 : 이메일 주소, 전화번호 등에 대한 기본적인 검증 수행\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"데이터베이스 또는 캐시 질의 : 알림에 포함시킬 데이터를 가져옴\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"알림 전송 : 알림 데이터를 메시지 큐에 넣는다.\",[\"$\",\"br\",null,{}],\"\\n\",\"➡️ 하나 이상의 메시지 큐를 사용으로 병렬적으로 처리\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"\\n\",[\"$\",\"p\",null,{\"children\":\"캐시 : 사용자 정보, 단말 정보, 알림 템플릿 등을 캐시한다.\"}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"\\n\",[\"$\",\"p\",null,{\"children\":\"데이터베이스 : 사용자, 알림, 설정 등 다양한 정보를 저장\"}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"\\n\",[\"$\",\"p\",null,{\"children\":\"메시지 큐 : 시스템 컴포넌트 간 의존성을 제거, 다량의 알림 전송일때 버퍼 역할\"}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"\\n\",[\"$\",\"p\",null,{\"children\":\"작업 서버 : 메시지 큐에서 전송할 알림을 꺼내서 제 3자 서비스로 전달\"}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"다음과 같은 과정을 거친다.\"}],\"\\n\",[\"$\",\"ol\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"API 호출하여 알림 서버로 알림 보냄\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"알림 서버는 메타데이터(사용자 정보, 단말 토큰, 알림 설정)를 캐시나 데이터베이스에서 가져옴\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"알림 서버는 전송할 알림에 맞는 이벤트를 만들어 한 큐에 넣는다.\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"작업 서버는 메시지 큐에서 알림 이벤트를 꺼낸다.\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"작업 서버는 알림을 제3자 서비스로 보낸다.\"}],\"\\n\"]}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"3단계 상세 설계\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"안정성\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"추가로 필요한 컴포넌트 및 고려 사항\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"개선된 설계안\"}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"세가지 내용을 좀더 자세히 알아보자\"}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"안정성\"}],\"\\n\",[\"$\",\"h4\",null,{\"children\":\"데이터 손실 방지\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"알림 전송 시스템의 가장 중요한 요구사항 중 하나는 어떤 상황에서도 알림이 소실되면 안된다는 것이다.(지연, 순서바뀜은 가능하지만 사라지면 안됨)\\n이 요구사항을 만족하려면 알림 데이터를 데이터베이스에 보관하고 재시도 메커니즘을 구현해야 한다.\"}],\"\\n\",[\"$\",\"img\",null,{\"src\":\"/images/LSS/dataforget.jpg\",\"width\":\"80%\",\"height\":\"100%\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"다음과 같이 알림 로그 데이터베이스를 유지하는 것이 한 가지 방법이다.\"}],\"\\n\",[\"$\",\"h4\",null,{\"children\":\"알림 중복 전송 방지\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"같은 알림이 여러번 반복되는 것을 완전히 막는 것은 가능하지 않다. 분산 시스템으로 가끔은 중복 전송되기도 한다.\",[\"$\",\"br\",null,{}],\"\\n\",\"그 빈도를 줄이려면\"]}],\"\\n\",[\"$\",\"ol\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"중복을 탐지하는 메커니즘 도입\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"오류를 신중하게 처리해야함\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"보내야할 알림이 도착, 이벤트ID를 검사하여 이전에 보낸 이벤트인지 확인\"}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"추가로 필요한 컴포넌트 및 고려사항\"}],\"\\n\",[\"$\",\"h4\",null,{\"children\":\"알림 템플릿\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"대형 알림 시스템은 많은 알림을 처리한다. 대부분이 형식이 비슷하다.\",[\"$\",\"br\",null,{}],\"\\n\",\"이러한 유사성을 고려하여 모든 부분을 처음부터 다시 만들 필요가 없도록(템플릿)한다.\",[\"$\",\"br\",null,{}],\"\\n\",\"오류 가능성이나 알림 작성에 드는 시간도 줄일 수 있다.\"]}],\"\\n\",[\"$\",\"h4\",null,{\"children\":\"알림 설정\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"여러 서비스는 사용자가 알림 설정을 조정할 수 있도록 하고있다.\",[\"$\",\"br\",null,{}],\"\\n\",\"이러한 정보는 알림 설정 테이블에 보관되며, 특정 종류의 알림을 보내기 전에 데이터베이스를 확인한 후 보낸다.\"]}],\"\\n\",[\"$\",\"h4\",null,{\"children\":\"전송률 제한\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"사용자에가 받을 수 있는 알림의 빈도를 제한하여 너무 많은 알림을 보내지 않도록한다.\"}],\"\\n\",[\"$\",\"h4\",null,{\"children\":\"재시도 방법\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"제3자 서비스가 알림 전송에 실패하면 해당알림을 재시도 전용 큐에 넣는다.\",[\"$\",\"br\",null,{}],\"\\n\",\"문제가 계속 발생시 개발자에게 통지한다.\"]}],\"\\n\",[\"$\",\"h4\",null,{\"children\":\"푸시 알림과 보안\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"모바일 푸시 알림의 경우 appKey와 appSecret을 사용하여 보안을 유지한다.\",[\"$\",\"br\",null,{}],\"\\n\",\"따라서 인증된 혹은 승인된 클라이언트만 알림을 보낼 수 있다.\"]}],\"\\n\",[\"$\",\"h4\",null,{\"children\":\"큐 모니터링\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"큐에 쌓인 알림의 개수가 모니터링할때 중요한 메트릭(주요사항)이다.\\n이 수가 너무크면 이벤트를 빠르게 처리하고 있지 못하고있다는 뜻이다.\"}],\"\\n\",[\"$\",\"h4\",null,{\"children\":\"이벤트 추적\"}],\"\\n\",[\"$\",\"img\",null,{\"src\":\"/images/LSS/eventAnalytics.jpg\",\"width\":\"70%\",\"height\":\"100%\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"여러 이벤트 들은 사용자를 이해하는데 중요하다.\",[\"$\",\"br\",null,{}],\"\\n\",\"데이터 분석 서비스를 통해 추적하게될 알림 시스템 이벤트의 사례이다.\"]}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"수정된 설계안\"}],\"\\n\",[\"$\",\"img\",null,{\"src\":\"/images/LSS/alarmSystem.jpg\",\"width\":\"100%\",\"height\":\"100%\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"알림 서버에 인증과 전송률 제한 기능이 추가\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"전송 실패 대응을 위한 재시도 기능 추가\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"전송 템플릿을 사용\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"모니터링과 추적 시스템 추가\"}],\"\\n\"]}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"4단계 마무리\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"안정성 : 실패율을 낮추기 위한 재시도 매커니즘 도입\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"보안 : appKey, appSecret를 이용한 알림을 보안\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"이벤트 추적 및 모니터링\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"사용자 설정 : 사용자가 알림 수신 설정\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"전송률 제한 : 사용자에게 알림을 보내는 빈도를 제한\"}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"다음과 같은 컴포넌트 구현 방버과 최적화 기법에 대해 알아보았다.\"}]]]}],null],\"segment\":\"__PAGE__?{\\\"slug\\\":\\\"LSS10\\\"}\"},\"styles\":[]}],\"segment\":[\"slug\",\"LSS10\",\"d\"]},\"styles\":[]}],\"segment\":\"blog\"},\"styles\":[]}]}],[\"$\",\"footer\",null,{\"className\":\"w-full max-w-3xl items-center \",\"children\":[[\"$\",\"div\",null,{\"className\":\"h-28\"}],\" \"]}]]}]}]}],null]}]]\n"])</script><script>self.__next_f.push([1,"5:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"1\",{\"children\":\"지호의 블로그\"}],[\"$\",\"meta\",\"2\",{\"name\":\"description\",\"content\":\"Generated by create next app\"}],[\"$\",\"meta\",\"3\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"link\",\"4\",{\"rel\":\"icon\",\"href\":\"/favicon.ico\",\"type\":\"image/x-icon\",\"sizes\":\"16x16\"}],[\"$\",\"meta\",\"5\",{\"name\":\"next-size-adjust\"}]]\nb:null\n"])</script></body></html>